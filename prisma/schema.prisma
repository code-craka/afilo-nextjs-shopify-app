generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model product_collection_products {
  product_id          String              @db.Uuid
  collection_id       String              @db.Uuid
  position            Int?                @default(0)
  created_at          DateTime?           @default(now()) @db.Timestamptz(6)
  product_collections product_collections @relation(fields: [collection_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products            products            @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([product_id, collection_id])
  @@index([collection_id], map: "idx_collection_products_collection")
  @@index([product_id], map: "idx_collection_products_product")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model product_collections {
  id                          String                        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  handle                      String                        @unique
  title                       String
  description                 String?
  description_html            String?
  image_url                   String?
  seo_title                   String?
  seo_description             String?
  status                      String                        @default("active")
  created_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  product_collection_products product_collection_products[]

  @@index([handle], map: "idx_collections_handle")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model product_pricing_tiers {
  id                  String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  product_id          String            @db.Uuid
  variant_id          String?           @db.Uuid
  tier_name           String
  minimum_quantity    Int               @default(1)
  maximum_quantity    Int?
  price               Decimal           @db.Decimal(10, 2)
  discount_percentage Decimal?          @default(0) @db.Decimal(5, 2)
  features            String[]          @default([])
  user_limits         Json?             @default("{\"maximum\": 999, \"minimum\": 1}")
  created_at          DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?         @default(now()) @db.Timestamptz(6)
  products            products          @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product_variants    product_variants? @relation(fields: [variant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([product_id], map: "idx_pricing_tiers_product")
  @@index([variant_id], map: "idx_pricing_tiers_variant")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model product_variants {
  id                    String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  product_id            String                  @db.Uuid
  title                 String
  sku                   String?                 @unique
  license_type          String
  max_seats             Int                     @default(1)
  license_terms         Json                    @default("{\"teamUse\": false, \"commercialUse\": false, \"extendedSupport\": false, \"sourceCodeIncluded\": false, \"customizationAllowed\": true, \"redistributionAllowed\": false}")
  price                 Decimal                 @db.Decimal(10, 2)
  price_multiplier      Decimal                 @default(1.00) @db.Decimal(5, 2)
  compare_at_price      Decimal?                @db.Decimal(10, 2)
  stripe_price_id       String?                 @unique
  available_for_sale    Boolean?                @default(true)
  quantity_available    Int?
  position              Int?                    @default(0)
  created_at            DateTime?               @default(now()) @db.Timestamptz(6)
  updated_at            DateTime?               @default(now()) @db.Timestamptz(6)
  product_pricing_tiers product_pricing_tiers[]
  products              products                @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([license_type], map: "idx_variants_license_type")
  @@index([product_id], map: "idx_variants_product_id")
  @@index([sku], map: "idx_variants_sku")
  @@index([stripe_price_id], map: "idx_variants_stripe_price_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model products {
  id                           String                        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  handle                       String                        @unique
  title                        String
  description                  String                        @default("")
  description_html             String?
  base_price                   Decimal                       @db.Decimal(10, 2)
  currency                     String                        @default("USD")
  compare_at_price             Decimal?                      @db.Decimal(10, 2)
  product_type                 String
  vendor                       String                        @default("Afilo")
  tags                         String[]                      @default([])
  tech_stack                   String[]                      @default([])
  version                      String?
  available_licenses           Json                          @default("[\"Personal\", \"Commercial\", \"Enterprise\"]")
  subscription_supported       Boolean?                      @default(false)
  subscription_interval        String?
  trial_period_days            Int?                          @default(0)
  minimum_users                Int?                          @default(1)
  maximum_users                Int?
  compliance_standards         String[]                      @default([])
  integration_capabilities     String[]                      @default([])
  support_level                String?                       @default("standard")
  has_documentation            Boolean?                      @default(false)
  has_demo                     Boolean?                      @default(false)
  demo_url                     String?
  documentation_url            String?
  system_requirements          Json?                         @default("{}")
  download_links               String[]                      @default([])
  access_instructions          String?
  activation_required          Boolean?                      @default(false)
  stripe_product_id            String?                       @unique
  stripe_price_id              String?
  stripe_subscription_price_id String?
  available_for_sale           Boolean?                      @default(true)
  featured                     Boolean?                      @default(false)
  status                       String                        @default("active")
  featured_image_url           String?
  images                       Json?                         @default("[]")
  seo_title                    String?
  seo_description              String?
  created_at                   DateTime?                     @default(now()) @db.Timestamptz(6)
  updated_at                   DateTime?                     @default(now()) @db.Timestamptz(6)
  published_at                 DateTime?                     @db.Timestamptz(6)
  product_collection_products  product_collection_products[]
  product_pricing_tiers        product_pricing_tiers[]
  product_variants             product_variants[]

  @@index([created_at(sort: Desc)], map: "idx_products_created_at")
  @@index([handle], map: "idx_products_handle")
  @@index([product_type], map: "idx_products_product_type")
  @@index([stripe_product_id], map: "idx_products_stripe_product_id")
  @@index([tags], map: "idx_products_tags", type: Gin)
  @@index([tech_stack], map: "idx_products_tech_stack", type: Gin)
  @@index([updated_at(sort: Desc)], map: "idx_products_updated_at")
  @@index([vendor], map: "idx_products_vendor")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model cart_items {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id           String
  product_id        String
  variant_id        String
  title             String
  price             Decimal   @db.Decimal(10, 2)
  quantity          Int       @default(1)
  license_type      String
  image_url         String?
  status            String    @default("active")
  added_at          DateTime? @default(now()) @db.Timestamptz(6)
  last_modified     DateTime? @default(now()) @db.Timestamptz(6)
  abandoned_at      DateTime? @db.Timestamptz(6)
  purchased_at      DateTime? @db.Timestamptz(6)
  stripe_session_id String?
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_cart_items_created_at")
  @@index([product_id, variant_id], map: "idx_cart_items_product")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model downloads {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerk_user_id   String
  subscription_id String?        @db.Uuid
  product_id      String
  product_title   String
  download_url    String
  license_key     String?
  download_count  Int?           @default(0)
  max_downloads   Int?           @default(10)
  expires_at      DateTime?      @db.Timestamp(6)
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  subscriptions   subscriptions? @relation(fields: [subscription_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([clerk_user_id], map: "idx_downloads_user")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model subscriptions {
  id                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerk_user_id        String
  email                String
  shopify_order_id     String?
  plan_id              String
  status               String
  current_period_start DateTime    @db.Timestamp(6)
  current_period_end   DateTime    @db.Timestamp(6)
  cancel_at_period_end Boolean?    @default(false)
  created_at           DateTime?   @default(now()) @db.Timestamp(6)
  updated_at           DateTime?   @default(now()) @db.Timestamp(6)
  downloads            downloads[]

  @@index([clerk_user_id], map: "idx_subscriptions_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model unified_products {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String    @db.VarChar(255)
  description          String?
  base_price           Int
  currency             String?   @default("USD") @db.VarChar(3)
  shopify_product_id   String?   @unique(map: "unique_shopify_product") @db.VarChar(255)
  shopify_variant_id   String?   @db.VarChar(255)
  shopify_handle       String?   @db.VarChar(255)
  shopify_synced_at    DateTime? @db.Timestamptz(6)
  stripe_product_id    String?   @unique(map: "unique_stripe_product") @db.VarChar(255)
  stripe_price_monthly String?   @db.VarChar(255)
  stripe_price_annual  String?   @db.VarChar(255)
  stripe_synced_at     DateTime? @db.Timestamptz(6)
  features             Json?     @default("[]")
  metadata             Json?     @default("{}")
  images               Json?     @default("[]")
  available_on_shopify Boolean?  @default(true)
  available_on_stripe  Boolean?  @default(false)
  active               Boolean?  @default(true)
  tier                 String?   @db.VarChar(50)
  user_limit           String?   @db.VarChar(50)
  product_type         String?   @db.VarChar(100)
  created_at           DateTime? @default(now()) @db.Timestamptz(6)
  updated_at           DateTime? @default(now()) @db.Timestamptz(6)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user_activity_log {
  id              Int            @id @default(autoincrement())
  user_profile_id Int?
  activity_type   String         @db.VarChar(50)
  activity_data   Json?
  ip_address      String?        @db.Inet
  user_agent      String?
  created_at      DateTime?      @default(now()) @db.Timestamptz(6)
  user_profiles   user_profiles? @relation(fields: [user_profile_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([activity_type], map: "idx_user_activity_log_activity_type")
  @@index([created_at], map: "idx_user_activity_log_created_at")
  @@index([user_profile_id], map: "idx_user_activity_log_user_profile_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// UPDATED: Added 'merchant' role for Stripe Connect marketplace vendors
model user_profiles {
  id                 Int                  @id @default(autoincrement())
  clerk_user_id      String               @unique @db.VarChar(255)
  email              String?              @db.VarChar(255)
  first_name         String?              @db.VarChar(255)
  last_name          String?              @db.VarChar(255)
  oauth_signup       Boolean?             @default(false)
  subscription_tier  String?              @default("free") @db.VarChar(50)
  company            String?              @db.VarChar(255)
  job_title          String?              @db.VarChar(255)
  phone              String?              @db.VarChar(50)
  avatar_url         String?
  last_login         DateTime?            @db.Timestamptz(6)
  created_at         DateTime?            @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?            @default(now()) @db.Timestamptz(6)
  role               String?              @default("standard") @db.VarChar(20)
  purchase_type      String?              @db.VarChar(20)
  user_activity_log  user_activity_log[]
  user_subscriptions user_subscriptions[]

  @@index([clerk_user_id], map: "idx_user_profiles_clerk_user_id")
  @@index([created_at], map: "idx_user_profiles_created_at")
  @@index([email], map: "idx_user_profiles_email")
  @@index([role], map: "idx_user_profiles_role")
  @@index([subscription_tier], map: "idx_user_profiles_subscription_tier")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user_subscriptions {
  id                      Int            @id @default(autoincrement())
  user_profile_id         Int?
  subscription_tier       String         @db.VarChar(50)
  price_paid              Decimal?       @db.Decimal(10, 2)
  billing_period          String?        @db.VarChar(20)
  start_date              DateTime       @db.Timestamptz(6)
  end_date                DateTime?      @db.Timestamptz(6)
  status                  String?        @default("active") @db.VarChar(20)
  shopify_subscription_id String?        @db.VarChar(255)
  created_at              DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at              DateTime?      @default(now()) @db.Timestamptz(6)
  user_profiles           user_profiles? @relation(fields: [user_profile_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([shopify_subscription_id], map: "idx_user_subscriptions_shopify_id")
  @@index([status], map: "idx_user_subscriptions_status")
  @@index([user_profile_id], map: "idx_user_subscriptions_user_profile_id")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model chat_conversations {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerk_user_id   String          @db.VarChar(255)
  title           String?         @db.VarChar(500)
  status          String          @default("active") @db.VarChar(50)
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  updated_at      DateTime        @default(now()) @db.Timestamptz(6)
  last_message_at DateTime        @default(now()) @db.Timestamptz(6)
  bot_analytics   bot_analytics[]
  chat_messages   chat_messages[]

  @@index([clerk_user_id], map: "idx_chat_conversations_user")
  @@index([status], map: "idx_chat_conversations_status")
  @@index([created_at], map: "idx_chat_conversations_created_at")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model chat_messages {
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id String             @db.Uuid
  role            String             @db.VarChar(20)
  content         String
  metadata        Json?              @default("{}")
  created_at      DateTime           @default(now()) @db.Timestamptz(6)
  conversation    chat_conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversation_id], map: "idx_chat_messages_conversation")
  @@index([created_at], map: "idx_chat_messages_created_at")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model knowledge_base {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  url             String   @unique
  title           String?  @db.VarChar(500)
  content         String
  content_type    String?  @db.VarChar(50)
  embedding       String?
  searchable_text String?
  metadata        Json?    @default("{}")
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  @@index([content_type], map: "idx_knowledge_base_content_type")
  @@index([created_at], map: "idx_knowledge_base_created_at")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model bot_analytics {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id String?             @db.Uuid
  event_type      String              @db.VarChar(100)
  event_data      Json?               @default("{}")
  created_at      DateTime            @default(now()) @db.Timestamptz(6)
  conversation    chat_conversations? @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversation_id], map: "idx_bot_analytics_conversation")
  @@index([event_type], map: "idx_bot_analytics_event_type")
  @@index([created_at], map: "idx_bot_analytics_created_at")
}

/// Cart Recovery System Models - Phase 2 Feature
model cart_recovery_campaigns {
  id                  String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String                     @db.VarChar(255)
  description         String?
  is_active           Boolean                    @default(true)
  trigger_delay_hours Int                        @default(24)
  email_template      String
  subject_line        String                     @db.VarChar(255)
  discount_percent    Decimal                    @default(0) @db.Decimal(5, 2)
  discount_code       String?                    @db.VarChar(50)
  total_sent          Int                        @default(0)
  total_opened        Int                        @default(0)
  total_clicked       Int                        @default(0)
  total_converted     Int                        @default(0)
  total_revenue       Decimal                    @default(0) @db.Decimal(10, 2)
  created_at          DateTime                   @default(now()) @db.Timestamptz(6)
  updated_at          DateTime                   @default(now()) @db.Timestamptz(6)
  email_logs          cart_recovery_email_logs[]
}

model cart_recovery_sessions {
  id                     String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cart_session_id        String                     @db.VarChar(255)
  clerk_user_id          String                     @db.VarChar(255)
  user_email             String                     @db.VarChar(255)
  user_name              String?                    @db.VarChar(255)
  total_items            Int                        @default(0)
  total_value            Decimal                    @default(0) @db.Decimal(10, 2)
  cart_data              Json?
  created_at             DateTime                   @default(now()) @db.Timestamptz(6)
  abandoned_at           DateTime?                  @db.Timestamptz(6)
  last_activity          DateTime                   @default(now()) @db.Timestamptz(6)
  status                 String                     @default("active") @db.VarChar(50)
  recovery_emails_sent   Int                        @default(0)
  last_email_sent_at     DateTime?                  @db.Timestamptz(6)
  recovered_at           DateTime?                  @db.Timestamptz(6)
  email_opened           Boolean                    @default(false)
  email_clicked          Boolean                    @default(false)
  recovery_discount_used Boolean                    @default(false)
  recovery_revenue       Decimal                    @default(0) @db.Decimal(10, 2)
  email_logs             cart_recovery_email_logs[]

  @@unique([cart_session_id, clerk_user_id])
  @@index([clerk_user_id], map: "idx_cart_recovery_sessions_user")
  @@index([status], map: "idx_cart_recovery_sessions_status")
  @@index([abandoned_at], map: "idx_cart_recovery_sessions_abandoned")
  @@index([created_at], map: "idx_cart_recovery_sessions_created")
}

model cart_recovery_email_logs {
  id                  String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recovery_session_id String                  @db.Uuid
  campaign_id         String                  @db.Uuid
  recipient_email     String                  @db.VarChar(255)
  subject_line        String                  @db.VarChar(255)
  email_content       String?
  discount_code       String?                 @db.VarChar(50)
  sent_at             DateTime                @default(now()) @db.Timestamptz(6)
  opened_at           DateTime?               @db.Timestamptz(6)
  clicked_at          DateTime?               @db.Timestamptz(6)
  converted_at        DateTime?               @db.Timestamptz(6)
  delivery_status     String                  @default("sent") @db.VarChar(50)
  error_message       String?
  cart_value_at_send  Decimal?                @db.Decimal(10, 2)
  recovery_revenue    Decimal                 @default(0) @db.Decimal(10, 2)
  campaign            cart_recovery_campaigns @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  session             cart_recovery_sessions  @relation(fields: [recovery_session_id], references: [id], onDelete: Cascade)

  @@index([recovery_session_id], map: "idx_cart_recovery_email_logs_session")
  @@index([campaign_id], map: "idx_cart_recovery_email_logs_campaign")
  @@index([sent_at], map: "idx_cart_recovery_email_logs_sent")
  @@index([delivery_status], map: "idx_cart_recovery_email_logs_status")
}

model cart_recovery_analytics {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date              DateTime @unique @db.Date
  carts_abandoned   Int      @default(0)
  carts_recovered   Int      @default(0)
  emails_sent       Int      @default(0)
  emails_opened     Int      @default(0)
  emails_clicked    Int      @default(0)
  potential_revenue Decimal  @default(0) @db.Decimal(10, 2)
  recovered_revenue Decimal  @default(0) @db.Decimal(10, 2)
  recovery_rate     Decimal  @default(0) @db.Decimal(5, 2)
  open_rate         Decimal  @default(0) @db.Decimal(5, 2)
  click_rate        Decimal  @default(0) @db.Decimal(5, 2)
  conversion_rate   Decimal  @default(0) @db.Decimal(5, 2)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @db.Timestamptz(6)

  @@index([date], map: "idx_cart_recovery_analytics_date")
}

/// Stripe Connect accounts for marketplace vendors/merchants
/// This table tracks all Connected accounts (Standard, Express, Custom)
model stripe_connect_accounts {
  id                    String                     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clerk_user_id         String                     @db.VarChar(255)
  stripe_account_id     String                     @unique @db.VarChar(255)
  account_type          String                     @db.VarChar(50)
  business_type         String?                    @db.VarChar(50)
  country               String?                    @db.VarChar(2)
  default_currency      String                     @default("USD") @db.VarChar(3)
  email                 String?                    @db.VarChar(255)
  business_name         String?                    @db.VarChar(255)
  capabilities          Json?                      @default("{}")
  requirements          Json?                      @default("{}")
  charges_enabled       Boolean                    @default(false)
  payouts_enabled       Boolean                    @default(false)
  details_submitted     Boolean                    @default(false)
  onboarding_status     String                     @default("pending") @db.VarChar(50)
  onboarding_link       String?
  onboarding_expires_at DateTime?                  @db.Timestamptz(6)
  metadata              Json?                      @default("{}")
  created_at            DateTime                   @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                   @default(now()) @db.Timestamptz(6)
  account_sessions      connect_account_sessions[]
  marketplace_transfers marketplace_transfers[]

  @@index([clerk_user_id], map: "idx_connect_accounts_clerk_user")
  @@index([stripe_account_id], map: "idx_connect_accounts_stripe_id")
  @@index([onboarding_status], map: "idx_connect_accounts_status")
  @@index([charges_enabled, payouts_enabled], map: "idx_connect_accounts_capabilities")
  @@index([created_at(sort: Desc)], map: "idx_connect_accounts_created")
}

/// Marketplace transfers to Connected accounts
/// Tracks all platform-to-merchant fund transfers
model marketplace_transfers {
  id                     String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  stripe_transfer_id     String                  @unique @db.VarChar(255)
  destination_account_id String                  @db.Uuid
  stripe_destination_id  String                  @db.VarChar(255)
  source_transaction     String?                 @db.VarChar(255)
  amount                 Decimal                 @db.Decimal(10, 2)
  currency               String                  @default("USD") @db.VarChar(3)
  application_fee_amount Decimal?                @db.Decimal(10, 2)
  transfer_group         String?                 @db.VarChar(255)
  description            String?
  status                 String                  @default("pending") @db.VarChar(50)
  failure_code           String?                 @db.VarChar(100)
  failure_message        String?
  metadata               Json?                   @default("{}")
  created_at             DateTime                @default(now()) @db.Timestamptz(6)
  updated_at             DateTime                @default(now()) @db.Timestamptz(6)
  destination_account    stripe_connect_accounts @relation(fields: [destination_account_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([destination_account_id], map: "idx_transfers_destination")
  @@index([stripe_transfer_id], map: "idx_transfers_stripe_id")
  @@index([status], map: "idx_transfers_status")
  @@index([created_at(sort: Desc)], map: "idx_transfers_created")
  @@index([source_transaction], map: "idx_transfers_source")
}

/// Connect Account Sessions for embedded components
/// Tracks component sessions for security and analytics
model connect_account_sessions {
  id                String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  account_id        String                  @db.Uuid
  stripe_account_id String                  @db.VarChar(255)
  client_secret     String                  @unique
  components        String[]                @default([])
  expires_at        DateTime                @db.Timestamptz(6)
  created_at        DateTime                @default(now()) @db.Timestamptz(6)
  account           stripe_connect_accounts @relation(fields: [account_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([account_id], map: "idx_sessions_account")
  @@index([stripe_account_id], map: "idx_sessions_stripe_account")
  @@index([expires_at], map: "idx_sessions_expires")
  @@index([created_at(sort: Desc)], map: "idx_sessions_created")
}

/// Enterprise API Monitoring - Track all API requests for performance and security
model api_monitoring {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  endpoint      String   @db.VarChar(500)
  method        String   @db.VarChar(10)
  status_code   Int
  response_time Int
  clerk_user_id String?  @db.VarChar(255)
  trace_id      String   @db.Uuid
  error_message String?
  request_size  Int?     @default(0)
  response_size Int?     @default(0)
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  @@index([endpoint], map: "idx_api_monitoring_endpoint")
  @@index([clerk_user_id], map: "idx_api_monitoring_user")
  @@index([status_code], map: "idx_api_monitoring_status")
  @@index([created_at(sort: Desc)], map: "idx_api_monitoring_created")
}

/// Enterprise Audit Logging - Comprehensive security and compliance audit trail
model audit_logs {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  action        String   @db.VarChar(100)
  resource      String   @db.VarChar(100)
  resource_id   String?  @db.VarChar(255)
  clerk_user_id String   @db.VarChar(255)
  details       Json?    @default("{}")
  risk_score    Int?     @default(0)
  ip_address    String?  @db.VarChar(45)
  user_agent    String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  @@index([action], map: "idx_audit_logs_action")
  @@index([resource], map: "idx_audit_logs_resource")
  @@index([clerk_user_id], map: "idx_audit_logs_user")
  @@index([risk_score], map: "idx_audit_logs_risk_score")
  @@index([created_at(sort: Desc)], map: "idx_audit_logs_created")
}

/// Enterprise Webhook Event Tracking - Monitor all incoming webhooks
model webhook_events {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  source          String    @db.VarChar(50)
  event_type      String    @db.VarChar(100)
  event_id        String    @unique @db.VarChar(255)
  payload         Json?     @default("{}")
  status          String    @default("pending") @db.VarChar(50)
  processing_time Int?
  error_message   String?
  retry_count     Int       @default(0)
  processed_at    DateTime? @db.Timestamptz(6)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)

  @@index([source], map: "idx_webhook_events_source")
  @@index([event_type], map: "idx_webhook_events_type")
  @@index([status], map: "idx_webhook_events_status")
  @@index([created_at(sort: Desc)], map: "idx_webhook_events_created")
}

/// Enterprise Rate Limiting - Track and enforce API rate limits
model rate_limit_tracking {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  identifier      String    @db.VarChar(255)
  identifier_type String    @db.VarChar(50)
  endpoint        String    @db.VarChar(500)
  request_count   Int       @default(0)
  window_start    DateTime  @db.Timestamptz(6)
  blocked         Boolean   @default(false)
  blocked_until   DateTime? @db.Timestamptz(6)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @db.Timestamptz(6)

  @@index([identifier], map: "idx_rate_limit_identifier")
  @@index([endpoint], map: "idx_rate_limit_endpoint")
  @@index([window_start], map: "idx_rate_limit_window")
  @@index([blocked], map: "idx_rate_limit_blocked")
}

/// ACH Authorization System - NACHA Compliant Authorization Tracking
/// Stores ACH authorization records for 7-year retention (NACHA requirement)
model ach_authorizations {
  id                      String                      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Customer Information
  clerk_user_id           String                      @db.VarChar(255)
  customer_name           String                      @db.VarChar(255)
  customer_email          String                      @db.VarChar(255)
  customer_ip_address     String?                     @db.VarChar(45)
  user_agent              String?

  // Bank Account Information (encrypted)
  bank_account_last4      String                      @db.VarChar(4)
  bank_routing_number     String                      // Encrypted
  bank_account_type       String                      @db.VarChar(20)
  bank_name               String?                     @db.VarChar(255)

  // Authorization Details
  authorization_type      String                      @db.VarChar(20)
  authorization_text      String
  payment_amount          Decimal?                    @db.Decimal(10, 2)
  recurring_frequency     String?                     @db.VarChar(20)
  recurring_max_amount    Decimal?                    @db.Decimal(10, 2)

  // Consent Capture
  consent_method          String                      @db.VarChar(50)
  consent_timestamp       DateTime                    @db.Timestamptz(6)
  consent_ip_address      String                      @db.VarChar(45)
  consent_user_agent      String
  consent_signature_data  String?
  consent_recording_url   String?

  // Transaction Context
  transaction_description String
  invoice_id              String?                     @db.VarChar(255)
  subscription_id         String?                     @db.VarChar(255)
  stripe_payment_method_id String?                    @db.VarChar(255)
  stripe_mandate_id       String?                     @db.VarChar(255)

  // Terms Displayed
  terms_version           String                      @db.VarChar(50)
  refund_policy_version   String                      @db.VarChar(50)
  tos_accepted            Boolean                     @default(false)
  privacy_accepted        Boolean                     @default(false)

  // Revocation
  is_revoked              Boolean                     @default(false)
  revoked_at              DateTime?                   @db.Timestamptz(6)
  revocation_reason       String?

  // Audit Trail
  created_at              DateTime                    @default(now()) @db.Timestamptz(6)
  updated_at              DateTime                    @default(now()) @db.Timestamptz(6)

  // Metadata for additional details
  metadata                Json?                       @default("{}")

  // Relations
  evidence                ach_authorization_evidence[]
  disputes                ach_dispute_inquiries[]

  @@index([clerk_user_id], map: "idx_ach_auth_user")
  @@index([customer_email], map: "idx_ach_auth_email")
  @@index([stripe_payment_method_id], map: "idx_ach_auth_stripe_pm")
  @@index([consent_timestamp], map: "idx_ach_auth_timestamp")
  @@index([is_revoked], map: "idx_ach_auth_revoked")
}

/// ACH Authorization Evidence - Supporting documentation for dispute protection
/// Stores proof of authorization files (screenshots, PDFs, etc.)
model ach_authorization_evidence {
  id                    String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  authorization_id      String              @db.Uuid

  // Evidence Details
  evidence_type         String              @db.VarChar(100)
  evidence_description  String

  // File Storage
  file_url              String?
  file_name             String?             @db.VarChar(500)
  file_size             Int?
  file_type             String?             @db.VarChar(100)

  // Hash for integrity verification
  file_hash             String?             @db.VarChar(64)

  created_at            DateTime            @default(now()) @db.Timestamptz(6)

  // Relations
  authorization         ach_authorizations  @relation(fields: [authorization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([authorization_id], map: "idx_ach_evidence_auth")
  @@index([evidence_type], map: "idx_ach_evidence_type")
}

/// ACH Dispute Inquiries - Track Stripe disputes and auto-submit evidence
/// Handles automatic dispute evidence submission to Stripe
model ach_dispute_inquiries {
  id                    String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  authorization_id      String?             @db.Uuid

  // Stripe Dispute Details
  stripe_dispute_id     String              @unique @db.VarChar(255)
  stripe_charge_id      String              @db.VarChar(255)
  stripe_payment_intent_id String?          @db.VarChar(255)

  // Inquiry Details
  inquiry_reason        String              @db.VarChar(255)
  inquiry_date          DateTime            @db.Timestamptz(6)
  inquiry_status        String              @db.VarChar(50)

  // Evidence Submission
  evidence_submitted_at DateTime?           @db.Timestamptz(6)
  evidence_documents    Json?               @default("[]")

  // Resolution
  resolved_at           DateTime?           @db.Timestamptz(6)
  resolution            String?             @db.VarChar(50)
  resolution_notes      String?

  // Audit
  created_at            DateTime            @default(now()) @db.Timestamptz(6)
  updated_at            DateTime            @default(now()) @db.Timestamptz(6)

  // Relations
  authorization         ach_authorizations? @relation(fields: [authorization_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([stripe_dispute_id], map: "idx_ach_dispute_stripe")
  @@index([authorization_id], map: "idx_ach_dispute_auth")
  @@index([inquiry_status], map: "idx_ach_dispute_status")
}
